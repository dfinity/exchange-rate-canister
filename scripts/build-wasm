#!/usr/bin/env bash
set -euo pipefail

cargo install ic-wasm --version 0.3.0 --root ./target

IP_SUPPORT=${IP_SUPPORT:-}
DISABLE_FOREX_WEEKEND_CHECK=${DISABLE_FOREX_WEEKEND_CHECK:-}
DISABLE_FOREX_TIMEZONE_OFFSET=${DISABLE_FOREX_TIMEZONE_OFFSET:-}

if [ -z "${IP_SUPPORT}" ]; then
    IP_SUPPORT="ipv4"
fi

if [ -z "${DISABLE_FOREX_WEEKEND_CHECK}" ]; then
    DISABLE_FOREX_WEEKEND_CHECK="no"
fi

if [ -z "${DISABLE_FOREX_TIMEZONE_OFFSET}" ]; then
    DISABLE_FOREX_TIMEZONE_OFFSET="no"
fi

FEATURES=()

if [ "${IP_SUPPORT}" == "ipv4" ]; then
    FEATURES+=('--features' 'ipv4-support')
fi

if [ "${DISABLE_FOREX_WEEKEND_CHECK}" == "yes" ]; then
    FEATURES+=('--features' 'disable-forex-weekend-check')
fi

if [ "${DISABLE_FOREX_TIMEZONE_OFFSET}" == "yes" ]; then
    FEATURES+=('--features' 'disable-forex-timezone-offset')
fi

echo "IP_SUPPORT: $IP_SUPPORT"
echo "DISABLE_FOREX_WEEKEND_CHECK: $DISABLE_FOREX_WEEKEND_CHECK"
echo "DISABLE_FOREX_TIMEZONE: $DISABLE_FOREX_TIMEZONE_OFFSET"

cargo build -p xrc --target wasm32-unknown-unknown --release "${FEATURES[@]}"

./target/bin/ic-wasm ./target/wasm32-unknown-unknown/release/xrc.wasm \
    -o ./target/wasm32-unknown-unknown/release/xrc.wasm shrink

./target/bin/ic-wasm \
    ./target/wasm32-unknown-unknown/release/xrc.wasm \
    -o ./target/wasm32-unknown-unknown/release/xrc.wasm \
    metadata candid:service --visibility public --file src/xrc/xrc.did